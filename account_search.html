<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account Search</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%237c3aed"/><path d="M18 40h14l-7-16-7 16Zm14 0h14l-7-16-7 16Z" fill="white"/></svg>'/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    window.addEventListener('error', function(e){
      if (e.target && e.target.src && e.target.src.includes('papaparse')) {
        var s=document.createElement('script');
        s.src='https://unpkg.com/papaparse@5.4.1/papaparse.min.js';
        document.head.appendChild(s);
      }
    }, true);
  </script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --accent:#7c3aed;
      --accent-ghost:#ede9fe;
      --ok:#16a34a;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;padding:32px 16px;}
    .wrap{max-width:900px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:24px;}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{font-size:22px;margin:0}
    .hint{color:var(--muted);font-size:13px;margin-top:6px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .input{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;outline:none;background:#fff;font-size:16px;}
    .input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-ghost)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;font-weight:600;font-size:14px;color:var(--accent);background:var(--accent-ghost);border:1px solid #ddd6fe;border-radius:10px;cursor:pointer;transition:transform .04s ease, background .2s ease, color .2s ease;}
    .btn:active{transform:scale(.98)}
    .btn svg{width:16px;height:16px;flex:0 0 16px}
    .grid{margin-top:18px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}.span2{grid-column:auto}}
    .span2{grid-column:1 / -1}
    .field{position:relative;border:1px solid var(--border);border-radius:12px;padding:12px 14px 14px 14px;background:#fff;min-height:72px}
    .label{font-weight:700;font-size:12px;letter-spacing:.02em;text-transform:uppercase;color:#475569;margin-bottom:6px}
    .value{font-weight:600;font-size:16px;color:#0b1220;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:36px}
    .value a{color:inherit;text-decoration:none;border-bottom:1px dotted #cbd5e1}
    .value a:hover{border-bottom-color:var(--accent)}
    .copy{position:absolute;top:10px;right:10px;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;padding:0;border-radius:8px;background:transparent;border:1px solid transparent;color:#64748b;opacity:.45;cursor:pointer;transition:opacity .15s ease, transform .04s ease, background .2s ease;}
    .field:hover .copy,.copy:focus{opacity:1}
    .copy:hover{background:#f8fafc}
    .copy:active{transform:scale(.96)}
    .copy svg{width:16px;height:16px}
    .copy.ok{color:var(--ok);background:#ecfdf5;border-color:#bbf7d0;opacity:1}
    .error{margin-top:12px;color:var(--danger);font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .gate{margin-bottom:16px;display:flex;gap:8px;align-items:center;}
    .gate .input{max-width:280px}
    .eye{margin-left:-40px;cursor:pointer;user-select:none;color:#94a3b8}
    .ta-wrap{position:relative}
    .ta-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:12px;margin-top:6px;max-height:280px;overflow:auto;box-shadow:0 12px 24px rgba(2,6,23,.08);z-index:20}
    .ta-item{padding:10px 12px;cursor:pointer}
    .ta-item:hover{background:#f1f5f9}
    .status{margin-top:8px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>Search Account</h1>
        <div>
          <button id="copyAllBtn" class="btn" type="button" title="Copy all fields (Slack markup)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm-2 6H10v2h7v-2Z"/>
            </svg>
            Copy All
          </button>
        </div>
      </div>

      <div class="gate" id="passwordRow">
        <div style="position:relative;display:flex;gap:8px;align-items:center;">
          <input type="password" id="passwordInput" class="input" placeholder="Enter password"/>
          <span id="togglePw" class="eye" title="Show/Hide">üëÅÔ∏è</span>
          <button id="passwordBtn" class="btn" type="button" aria-label="Submit password">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Submit
          </button>
        </div>
        <span id="gateMsg" class="muted">Locked. Enter password to continue.</span>
      </div>

      <div class="hint">Type 2+ characters to search. Select from the dropdown.</div>

      <div class="row ta-wrap">
        <input id="accountInput" class="input" placeholder="Start typing to search..." autocomplete="off" disabled/>
        <div id="taList" class="ta-list" hidden></div>
      </div>
      <div class="status" id="statusLine">Locked ‚Ä¢ v1.8-not-assigned-email</div>

      <div class="grid" aria-live="polite">
        <div class="field">
          <div class="label">Pure AE</div>
          <div class="value" id="owner">‚Äî</div>
          <button class="copy" data-target="owner" aria-label="Copy Pure AE" title="Copy">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
          </button>
        </div>

        <div class="field">
          <div class="label">Pure AE Email</div>
          <div class="value" id="email">‚Äî</div>
          <button class="copy" data-target="email" aria-label="Copy Pure AE Email" title="Copy">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
          </button>
        </div>

        <div class="field span2">
          <div class="label">Pure RSD</div>
          <div class="value" id="manager">‚Äî</div>
          <button class="copy" data-target="manager" aria-label="Copy Pure RSD" title="Copy">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
          </button>
        </div>

        <div class="field span2">
          <div class="label">Regional PAM</div>
          <div class="value" id="pam">‚Äî</div>
          <button class="copy" data-target="pam" aria-label="Copy Regional PAM" title="Copy">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
          </button>
        </div>
      </div>

      <div class="error" id="errorMessage"></div>
    </div>
  </div>

  <script>
    // Config
    const ENABLE_PASSWORD = true;
    const PASSWORD_VALUE = 'team2025';

    // Query params
    const urlParams = new URLSearchParams(window.location.search);
    const CSV_OVERRIDE = urlParams.get('csv');
    const PW_OVERRIDE = urlParams.get('pw') || urlParams.get('unlock');

    // CSV sources
    const CSV_URLS = (CSV_OVERRIDE && CSV_OVERRIDE.trim())
      ? [CSV_OVERRIDE.trim()]
      : ['Americas.csv', './Americas.csv', 'https://raw.githubusercontent.com/jwsiejk/accountlist/main/Americas.csv'];

    const MAX_SUGGESTIONS = 100;

    // Elements
    const accountInput = document.getElementById('accountInput');
    const ownerSpan = document.getElementById('owner');
    const managerSpan = document.getElementById('manager');
    const pamSpan = document.getElementById('pam');
    const emailSpan = document.getElementById('email');
    const errorDiv = document.getElementById('errorMessage');
    const statusLine = document.getElementById('statusLine');
    const copyAllBtn = document.getElementById('copyAllBtn');

    const passwordRow = document.getElementById('passwordRow');
    const passwordInput = document.getElementById('passwordInput');
    const passwordBtn = document.getElementById('passwordBtn');
    const gateMsg = document.getElementById('gateMsg');
    const togglePw = document.getElementById('togglePw');

    let accounts = [];
    let ready = false;

    function setValues({owner='‚Äî',manager='‚Äî',pam='‚Äî',email='‚Äî'}={}) {
      // Normalize owner: if it's the Salesforce service account, treat as Not Assigned
      const ownerNorm = (owner || '').toString().trim();
      const isService = ownerNorm.toLowerCase() === 'salesforce service account';
      const ownerOut = ownerNorm ? (isService ? 'Not Assigned' : ownerNorm) : '';
      ownerSpan.textContent = ownerOut || '‚Äî';
      // Email: if service account, leave blank; otherwise show link or '‚Äî'
      const emailNorm = (email || '').toString().trim();
      const emailOut = isService ? '' : emailNorm;
      const showDash = !isService;
      managerSpan.textContent = manager || '‚Äî';
      pamSpan.textContent = pam || '‚Äî';
      if (emailOut && emailOut.includes('@')) {
        emailSpan.innerHTML = `<a href="mailto:${emailOut}">${emailOut}</a>`;
      } else {
        emailSpan.textContent = showDash ? (emailOut || '‚Äî') : '';
      }
    }

    // Status + error
    function ok(msg) { statusLine.textContent = msg; }
    function err(msg) { errorDiv.textContent = msg; }

    // Gate helpers
    function unlock() {
      passwordRow.style.display = 'none';
      accountInput.disabled = false;
      ok('Ready ‚Ä¢ v1.8-not-assigned-email');
      loadData();
    }
    function checkPassword() {
      const entered = (passwordInput.value || '').trim();
      if (entered === PASSWORD_VALUE) {
        unlock();
      } else {
        gateMsg.textContent = 'Incorrect password. Check for extra spaces/caps and try again.';
        gateMsg.style.color = '#b91c1c';
      }
      passwordInput.value = '';
    }

    // Listeners for gate
    passwordBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkPassword(); });
    togglePw.addEventListener('click', () => {
      passwordInput.type = (passwordInput.type === 'password') ? 'text' : 'password';
    });
    if ((PW_OVERRIDE || '').trim() === PASSWORD_VALUE) { unlock(); }

    // Utility: find header name case-insensitively
    const findHeader = (fields, candidates) => {
      const lower = fields.map(f => (f||'').toString().trim().toLowerCase());
      for (const c of candidates) {
        const idx = lower.indexOf(c.toLowerCase());
        if (idx !== -1) return fields[idx];
      }
      return null;
    };

    async function fetchFirstWorking(urls) {
      for (const url of urls) {
        try {
          const res = await fetch(url, {cache:'no-store'});
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const text = await res.text();
          if (text && text.length > 0) return text;
        } catch (e) {
          // try next
        }
      }
      throw new Error('All CSV URLs failed');
    }

    function parseCSV(text) {
      return new Promise((resolve, reject) => {
        if (!window.Papa) { reject('PapaParse not loaded'); return; }
        window.Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: ({ data, meta }) => resolve({ data, meta }),
          error: (e) => reject(e || 'Parse error')
        });
      });
    }

    async function loadData() {
      ok('Loading CSV‚Ä¶ ‚Ä¢ v1.8-not-assigned-email');
      try {
        const text = await fetchFirstWorking(CSV_URLS);
        await processCSVText(text);
      } catch (e) {
        ok('Locked ‚Ä¢ v1.8-not-assigned-email');
        err('Network load failed. Place "Americas.csv" next to this HTML or use the ?csv= query param to point at a URL.');
      }
    }

    async function processCSVText(text) {
      const { data, meta } = await parseCSV(text);
      const fields = meta.fields || [];
      if (!fields.length || !data.length) throw new Error('Invalid CSV: missing headers or rows.');

      const nameH   = findHeader(fields, ['account name','account','name','customer name']);
      const ownerH  = findHeader(fields, ['account owner','owner','pure ae']);
      const mgrH    = findHeader(fields, ['manager','rsd','regional sales director','pure rsd']);
      const pamH    = findHeader(fields, ['account pam','pam','regional pam']);
      const emailH  = findHeader(fields, ['owner email','account owner email','ae email','pure ae email']);

      if (!nameH) throw new Error('Could not find an Account Name column.');

      accounts = data.map(row => ({
        name: (row[nameH] || '').toString().trim(),
        lname: (row[nameH] || '').toString().trim().toLowerCase(),
        owner: row[ownerH] || '',
        manager: row[mgrH] || '',
        pam: row[pamH] || '',
        email: row[emailH] || ''
      })).filter(a => a.name);

      ready = true;
      ok(`Loaded ${accounts.length.toLocaleString()} accounts ‚Ä¢ v1.8-not-assigned-email`);
    }

    // Typeahead dropdown
    const taList = document.getElementById('taList');
    function renderSuggestions(q) {
      if (!ready) return;
      const s = q.trim().toLowerCase();
      if (s.length < 2) { taList.hidden = true; taList.innerHTML = ''; return; }
      const out = [];
      for (let i = 0, seen = 0; i < accounts.length && seen < MAX_SUGGESTIONS; i++) {
        if (accounts[i].lname.includes(s)) {
          out.push('<div class="ta-item" data-name="' + accounts[i].name.replace(/"/g,'&quot;') + '">' + accounts[i].name + '</div>');
          seen++;
        }
      }
      if (!out.length) { taList.hidden = true; taList.innerHTML = ''; return; }
      taList.innerHTML = out.join('');
      taList.hidden = false;
    }
    function selectByName(name) {
      const a = accounts.find(x => x.name === name);
      if (a) {
        setValues(a);
        accountInput.value = name;
      }
      taList.hidden = true;
      taList.innerHTML = '';
    }
    accountInput.addEventListener('input', (e) => renderSuggestions(e.target.value));
    accountInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const first = taList.querySelector('.ta-item');
        if (first) selectByName(first.getAttribute('data-name'));
      }
    });
    taList.addEventListener('click', (e) => {
      const item = e.target.closest('.ta-item');
      if (item) selectByName(item.getAttribute('data-name'));
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.ta-wrap')) { taList.hidden = true; }
    });

    // Copy buttons with feedback
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.copy');
      if (!btn) return;
      const targetId = btn.getAttribute('data-target');
      if (!targetId) return;
      const el = document.getElementById(targetId);
      const text = el ? (el.textContent || el.innerText || '').trim() : '';
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('ok');
        setTimeout(() => btn.classList.remove('ok'), 800);
      });
    });

    // Copy All (Slack markup)
    copyAllBtn.addEventListener('click', () => {
      const account = (accountInput.value || '').trim();
      const owner = (ownerSpan.textContent || '').trim();
      const email = (emailSpan.textContent || '').trim();
      const manager = (managerSpan.textContent || '').trim();
      const pam = (pamSpan.textContent || '').trim();

      const lines = [];
      if (account) lines.push('*' + account + '*');
      const emailSlack = email ? '<mailto:' + email + '|' + email + '>' : '';
      lines.push('‚Ä¢ *Pure AE:* ' + (owner || '') + (emailSlack ? '  |  ' + emailSlack : ''));
      lines.push('‚Ä¢ *Pure RSD:* ' + (manager || ''));
      lines.push('‚Ä¢ *Regional PAM:* ' + (pam || ''));
      const out = lines.join('\n');

      navigator.clipboard.writeText(out).then(() => {
        const original = copyAllBtn.innerHTML;
        copyAllBtn.innerHTML = '‚úì Copied';
        setTimeout(() => { copyAllBtn.innerHTML = original; }, 1200);
      });
    });

  </script>
</body>
</html>
